set-option -g default-terminal "tmux-256color"

# Terminal features and overrides
set-option -ga terminal-features ",*:RGB" # Enable 24-bit colours
set-option -ga terminal-features ",*:strikethrough" # Enable strikethrough
set-option -ga terminal-features ",*:usstyle" # Enable underline
set-option -ga terminal-features ",*:RGB" # Enable 24-bit colours
set-option -ga terminal-overrides ",*:Tc" # Enable True Colour
set-option -ga terminal-overrides ",*:Smulx=\\E[4::%p1%dm" # Enable undercurl support
set-option -ga terminal-overrides ",*:Setulc=\\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m" # Enable underscore colours - needs tmux-3.0

# Check if we are in WSL
if-shell 'test -n "$WSL_DISTRO_NAME"' {
  set -ga terminal-overrides ",*:Setulc=\\E[58::2::::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m" # Enable underscore colours - needs tmux-3.0 (wsl2 in Windows Terminal)
}

# Set the escape time to 0 for faster key repetition
set-option -g escape-time 0

# Modern tmux features
set-option -g extended-keys on
set-option -g focus-events on
set-option -g set-clipboard on

set-option -g window-status-separator ""
set-option -g renumber-windows on

# Improve window sizing behavior
set-option -g aggressive-resize on

# Modern theme detection with automatic switching hooks (with debug notifications)
set-hook -g client-dark-theme 'display-message "ðŸŒ™ Dark theme hook triggered!"; source-file ~/.dotconfigs/tmux/gruvbox.conf; set-environment -g SYSTEM_COLOR_THEME dark'
set-hook -g client-light-theme 'display-message "â˜€ï¸ Light theme hook triggered!"; source-file ~/.dotconfigs/tmux/rose-pine-dawn.conf; set-environment -g SYSTEM_COLOR_THEME light'

# Fallback theme detection for initial setup and unsupported terminals
if-shell '[ "$(systemd-detect-virt 2>/dev/null)" = "wsl" ]' \
    'if-shell "reg.exe Query \"HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize\" /v AppsUseLightTheme 2>/dev/null | awk \"{if (match(\\$0, /0x/)) print substr(\\$3, 3, 1)}\" | grep -q \"0\"" \
        "source-file ~/.dotconfigs/tmux/gruvbox.conf; set-environment -g SYSTEM_COLOR_THEME dark" \
        "source-file ~/.dotconfigs/tmux/rose-pine-dawn.conf; set-environment -g SYSTEM_COLOR_THEME light"' \
    'if-shell "gsettings get org.gnome.desktop.interface color-scheme 2>/dev/null | grep -q \"prefer-dark\"" \
        "source-file ~/.dotconfigs/tmux/gruvbox.conf; set-environment -g SYSTEM_COLOR_THEME dark" \
        "source-file ~/.dotconfigs/tmux/rose-pine-dawn.conf; set-environment -g SYSTEM_COLOR_THEME light"'

# Windows will start from 1..n
set-option -g base-index 1
set-option -g pane-base-index 1

# Mouse support
set-option -g mouse on

# Prefix
unbind-key C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# Pane navigation (with and without Ctrl)
bind-key h   select-pane -L
bind-key C-h select-pane -L
bind-key j   select-pane -D
bind-key C-j select-pane -D
bind-key k   select-pane -U
bind-key C-k select-pane -U
bind-key l   select-pane -R
bind-key C-l select-pane -R

# Window movement
bind-key -r "<" swap-window -d -t -1
bind-key -r ">" swap-window -d -t +1

# Pane resizing (with repeat flag)
bind-key -r H resize-pane -L 5
bind-key -r J resize-pane -D 5
bind-key -r K resize-pane -U 5
bind-key -r L resize-pane -R 5

# Pane splitting (using current path)
bind-key "|" split-window -h -c "#{pane_current_path}"
bind-key "\\" split-window -fh -c "#{pane_current_path}"
bind-key "-" split-window -v -c "#{pane_current_path}"
bind-key "_" split-window -fv -c "#{pane_current_path}"
bind-key "%" split-window -h -c "#{pane_current_path}"
bind-key '"' split-window -v -c "#{pane_current_path}"

# New window in current path
bind-key "c" new-window -c "#{pane_current_path}"

# Hot reload of config
bind-key r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# Enable vi keys.
set-option -g mode-keys vi

# Disable <prefix>-Enter to initiate copy-mode-vi
unbind-key -T copy-mode Enter

# Selection keys to be used in copy-mode-vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Key and mouse to copy selection in copy-mode-vi
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel

bind-key s display-popup -E "~/.dotconfigs/tmux/scripts/session-switcher.sh"

bind-key w display-popup -E "~/.dotconfigs/tmux/scripts/window-switcher.sh"

bind-key S display-popup -E "~/.dotconfigs/tmux/scripts/new-session-from-directory.sh"

bind-key a display-popup -E "~/.dotconfigs/tmux/scripts/new-session-interactive-path.sh"

# Show directory selection on first tmux session
set-hook -g after-new-session 'display-popup -E "~/.dotconfigs/tmux/scripts/first-session-directory.sh"'

# Debug bindings for theme testing (using menu to avoid conflicts)
bind-key T display-menu -T "Theme Test" -x C -y C \
    "Dark Theme" d "run-shell 'tmux set-hook -Rg client-dark-theme'" \
    "Light Theme" l "run-shell 'tmux set-hook -Rg client-light-theme'"
